<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceVerse - AI Text-to-Speech Application | Convert Text to Natural Speech</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="VoiceVerse is an AI-powered text-to-speech application that converts your text into natural, high-quality audio using advanced voice synthesis technology. Create, manage, and organize audio files with ease.">
    <meta name="keywords" content="text to speech, TTS, AI voice, audio generation, speech synthesis, voice synthesis, text to audio, VoiceVerse">
    <meta name="author" content="VoiceVerse">
    <meta name="application-name" content="VoiceVerse">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://voiceverse.app/">
    <meta property="og:title" content="VoiceVerse - AI Text-to-Speech Application">
    <meta property="og:description" content="Convert text to natural speech with AI-powered voice synthesis. Create, manage, and organize high-quality audio files effortlessly.">
    <meta property="og:site_name" content="VoiceVerse">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://voiceverse.app/">
    <meta name="twitter:title" content="VoiceVerse - AI Text-to-Speech Application">
    <meta name="twitter:description" content="Convert text to natural speech with AI-powered voice synthesis. Create, manage, and organize high-quality audio files effortlessly.">

    <!-- Additional Metadata -->
    <meta name="theme-color" content="#1DB954">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://voiceverse.app/">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --spotify-green: #1DB954;
            --spotify-dark: #121212;
            --spotify-darker: #000000;
            --spotify-gray: #181818;
            --spotify-light-gray: #282828;
            --spotify-text: #FFFFFF;
            --spotify-text-gray: #B3B3B3;
            --spotify-hover: #1ed760;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--spotify-darker);
            color: var(--spotify-text);
            min-height: 100vh;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: auto;
        }

        .sidebar {
            width: 280px;
            background-color: var(--spotify-darker);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--spotify-text);
            margin-bottom: 20px;
        }

        .logo h2 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        /* Screen reader only class for accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--spotify-text-gray);
            font-weight: 600;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--spotify-text);
            background-color: var(--spotify-light-gray);
        }

        .groups-section {
            margin-top: 16px;
        }

        .groups-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--spotify-text-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding: 0 16px;
            margin-top: 0;
        }

        .group-item {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--spotify-text-gray);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-item:hover {
            color: var(--spotify-text);
            background-color: var(--spotify-light-gray);
        }

        .group-item.active {
            color: var(--spotify-green);
        }

        .group-count {
            font-size: 12px;
            color: var(--spotify-text-gray);
        }

        .group-menu-btn {
            background: transparent;
            border: none;
            color: var(--spotify-text-gray);
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .group-item:hover .group-menu-btn {
            opacity: 1;
        }

        .group-menu-btn:hover {
            background: var(--spotify-gray);
            color: var(--spotify-text);
        }

        .history-section {
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 16px;
        }

        .history-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--spotify-text-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .clear-history-btn {
            background: transparent;
            border: none;
            color: var(--spotify-text-gray);
            cursor: pointer;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .clear-history-btn:hover {
            background: var(--spotify-gray);
            color: var(--spotify-text);
        }

        .account-switcher {
            position: relative;
            margin-bottom: 8px;
        }

        .account-switcher-btn {
            width: auto !important;
            min-width: auto !important;
            max-width: fit-content !important;
            padding: 6px 14px !important;
            background: var(--spotify-light-gray);
            border: none;
            border-radius: 6px;
            color: var(--spotify-text);
            cursor: pointer;
            display: inline-block !important;
            white-space: nowrap !important;
            flex-grow: 0 !important;
            flex-shrink: 0 !important;
            transition: all 0.2s;
            font-weight: 600;
        }

        .account-switcher-btn:hover {
            background: var(--spotify-gray);
        }

        .account-dropdown {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--spotify-light-gray);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            margin-bottom: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .account-dropdown.show {
            display: block;
        }

        .account-option {
            padding: 12px 16px;
            cursor: pointer;
            color: var(--spotify-text);
            transition: all 0.2s;
            border-radius: 4px;
            margin: 4px;
        }

        .account-option:hover {
            background: var(--spotify-gray);
        }

        .account-option.current {
            background: rgba(29, 185, 84, 0.1);
            color: var(--spotify-green);
        }

        .account-option-label {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-account-btn {
            padding: 12px 16px;
            background: rgba(29, 185, 84, 0.1);
            color: var(--spotify-green);
            border-top: 1px solid var(--spotify-gray);
            margin-top: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 600;
        }

        .add-account-btn:hover {
            background: rgba(29, 185, 84, 0.2);
        }

        .history-item {
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--spotify-text-gray);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            margin: 2px 0;
        }

        .history-item:hover {
            background: var(--spotify-light-gray);
            color: var(--spotify-text);
        }

        .history-item-info {
            flex: 1;
            overflow: hidden;
        }

        .history-item-name {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .history-item-time {
            font-size: 11px;
            color: var(--spotify-text-gray);
        }

        .history-play-btn {
            background: none;
            border: none;
            color: var(--spotify-text-gray);
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            opacity: 0;
            transition: all 0.2s;
        }

        .history-item:hover .history-play-btn {
            opacity: 1;
        }

        .history-play-btn:hover {
            color: var(--spotify-green);
            transform: scale(1.2);
        }

        .no-history {
            padding: 16px;
            text-align: center;
            color: var(--spotify-text-gray);
            font-size: 12px;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--spotify-gray), var(--spotify-light-gray));
            padding: 20px;
            border-radius: 8px;
            margin-top: auto;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .stat-label {
            color: var(--spotify-text-gray);
        }

        .stat-value {
            color: var(--spotify-green);
            font-weight: 700;
        }

        .main-content {
            flex: 1;
            background-color: var(--spotify-dark);
            overflow-y: auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
        }

        .search-bar {
            background: var(--spotify-gray);
            border: none;
            padding: 12px 20px;
            border-radius: 500px;
            color: var(--spotify-text);
            width: 300px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--spotify-green);
            color: var(--spotify-text);
            border: none;
            padding: 12px 32px;
            border-radius: 500px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: var(--spotify-hover);
            transform: scale(1.04);
        }

        .settings-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--spotify-text);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--spotify-text);
            border: 1px solid var(--spotify-text-gray);
            padding: 10px 28px;
            border-radius: 500px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--spotify-text);
            transform: scale(1.04);
        }

        /* AI Agent Styles */
        .ai-toggle-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .ai-toggle-container:hover {
            background: rgba(138, 43, 226, 0.15);
        }

        .ai-toggle-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #bb86fc;
            margin-top: 2px;
        }

        .ai-toggle-label {
            flex: 1;
            color: var(--spotify-text);
        }

        .ai-suggest-btn, .ai-analyze-btn {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(138, 43, 226, 0.5);
            background: rgba(138, 43, 226, 0.1);
            color: #bb86fc;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .ai-suggest-btn:hover, .ai-analyze-btn:hover {
            background: rgba(138, 43, 226, 0.2);
            border-color: #bb86fc;
            transform: translateY(-2px);
        }

        .ai-suggest-btn:disabled, .ai-analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .file-card {
            background: var(--spotify-gray);
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-card:hover {
            background: var(--spotify-light-gray);
            transform: translateY(-4px);
        }

        .file-card-icon {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--spotify-green), #1ed760);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 12px;
            position: relative;
            border: none;
            cursor: pointer;
            color: inherit;
        }

        .play-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 48px;
            height: 48px;
            background: var(--spotify-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            font-size: 20px;
        }

        .file-card:hover .play-button {
            opacity: 1;
            transform: translateY(-4px);
        }

        .file-card-title {
            font-weight: 700;
            margin-bottom: 4px;
            margin-top: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 16px;
        }

        .file-card-meta {
            font-size: 13px;
            color: var(--spotify-text-gray);
        }

        .file-card-options {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
            font-size: 20px;
            border: none;
            color: var(--spotify-text);
        }

        .file-card:hover .file-card-options {
            opacity: 1;
        }

        .file-checkbox {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 24px;
            height: 24px;
            z-index: 15;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .file-card:hover .file-checkbox,
        .file-checkbox:checked {
            opacity: 1;
        }

        .file-card.selected {
            outline: 2px solid var(--spotify-green);
            outline-offset: -2px;
        }

        .bulk-toggle-btn {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--spotify-green);
            color: var(--spotify-darker);
            border: none;
            padding: 12px 20px;
            border-radius: 500px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            z-index: 999;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .bulk-toggle-btn.active {
            display: flex;
        }

        .bulk-toggle-btn:hover {
            background: #2ebd59;
            transform: scale(1.05);
        }

        .bulk-action-bar {
            position: fixed;
            top: 70px;
            right: 24px;
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
            background: var(--spotify-light-gray);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 998;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .bulk-action-bar.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .bulk-count {
            font-weight: 700;
            color: var(--spotify-text);
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid var(--spotify-darker);
            margin-bottom: 4px;
        }

        .bulk-btn {
            background: var(--spotify-gray);
            border: none;
            color: var(--spotify-text);
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .bulk-btn:hover {
            background: var(--spotify-darker);
            transform: translateX(2px);
        }

        .bulk-btn.danger {
            color: #ff4444;
        }

        .bulk-btn.danger:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        .group-select-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .group-select-modal.active {
            display: flex;
        }

        .group-select-content {
            background: var(--spotify-light-gray);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 600px;
            overflow-y: auto;
        }

        .group-select-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--spotify-text);
            margin-bottom: 16px;
        }

        .group-select-item {
            background: var(--spotify-gray);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .group-select-item:hover {
            background: var(--spotify-darker);
            transform: translateX(4px);
        }

        .group-select-item.new-group {
            background: var(--spotify-green);
            color: var(--spotify-darker);
            font-weight: 700;
        }

        .group-select-item.new-group:hover {
            background: #2ebd59;
        }

        .group-select-cancel {
            background: transparent;
            border: 1px solid var(--spotify-text-gray);
            color: var(--spotify-text);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .group-select-cancel:hover {
            border-color: var(--spotify-text);
            background: rgba(255, 255, 255, 0.1);
        }

        .player-bar {
            height: 90px;
            background-color: var(--spotify-gray);
            border-top: 1px solid var(--spotify-darker);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
        }

        .now-playing {
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .now-playing-art {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--spotify-green), #1ed760);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .now-playing-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .now-playing-info p {
            font-size: 12px;
            color: var(--spotify-text-gray);
        }

        .player-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .control-buttons {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--spotify-text-gray);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            padding: 8px;
            border-radius: 4px;
            position: relative;
        }

        .control-btn:hover {
            color: var(--spotify-text);
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.1);
        }

        .control-btn.active {
            color: var(--spotify-green);
            background: rgba(30, 215, 96, 0.15);
        }

        .control-btn.active:hover {
            background: rgba(30, 215, 96, 0.25);
        }

        .control-btn.play {
            width: 36px;
            height: 36px;
            background: var(--spotify-text);
            color: var(--spotify-darker);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-bar {
            width: 100%;
            max-width: 600px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--spotify-text-gray);
        }

        .progress-track {
            flex: 1;
            height: 4px;
            background: var(--spotify-light-gray);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--spotify-text);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }

        .volume-controls {
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: var(--spotify-light-gray);
            border-radius: 2px;
            cursor: pointer;
        }

        .volume-fill {
            height: 100%;
            background: var(--spotify-text);
            border-radius: 2px;
            width: 100%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--spotify-text-gray);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--spotify-gray);
            border: 1px solid var(--spotify-light-gray);
            border-radius: 4px;
            color: var(--spotify-text);
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            font-family: inherit;
        }

        .char-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--spotify-text-gray);
            margin-top: 8px;
        }

        .cost-estimate {
            color: var(--spotify-green);
        }

        .file-upload-area {
            background: var(--spotify-gray);
            border: 2px dashed var(--spotify-text-gray);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 16px;
        }

        .file-upload-area:hover {
            border-color: var(--spotify-green);
            background: var(--spotify-light-gray);
        }

        .file-upload-area.dragover {
            border-color: var(--spotify-green);
            background: var(--spotify-light-gray);
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .file-upload-text {
            color: var(--spotify-text);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .file-upload-hint {
            color: var(--spotify-text-gray);
            font-size: 12px;
        }

        .uploaded-file-info {
            background: var(--spotify-light-gray);
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .uploaded-file-name {
            color: var(--spotify-text);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-file-btn {
            background: transparent;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            transition: all 0.2s;
        }

        .remove-file-btn:hover {
            transform: scale(1.2);
        }

        .voice-card {
            background: var(--spotify-gray);
            padding: 16px;
            border-radius: 8px;
            border: 2px solid var(--spotify-gray);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .voice-card:hover {
            border-color: var(--spotify-text-gray);
        }

        .voice-card.selected {
            border-color: var(--spotify-green);
            background: rgba(29, 185, 84, 0.1);
        }

        .voice-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .voice-desc {
            color: var(--spotify-text-gray);
            font-size: 13px;
        }

        .voice-preview-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(29, 185, 84, 0.2);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            z-index: 10;
        }

        .voice-preview-btn:hover {
            background: rgba(29, 185, 84, 0.4);
            transform: scale(1.1);
        }

        .voice-preview-btn.loading {
            animation: pulse 1s infinite;
        }

        .voice-preview-btn.playing {
            background: var(--spotify-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 24px;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 1200px) {
            .comparison-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .comparison-card {
            background: var(--spotify-light-gray);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            box-sizing: border-box;
            min-width: 0;
        }

        .comparison-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .comparison-card.playing {
            border-color: var(--spotify-green);
            background: var(--spotify-gray);
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.3);
        }

        .comparison-voice-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--spotify-text);
            margin-bottom: 4px;
        }

        .comparison-voice-desc {
            color: var(--spotify-text-gray);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .comparison-play-btn {
            width: 100%;
            background: var(--spotify-green);
            color: var(--spotify-darker);
            border: none;
            padding: 12px;
            border-radius: 500px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .comparison-play-btn:hover {
            background: #2ebd59;
            transform: scale(1.05);
        }

        .comparison-play-btn:disabled {
            background: var(--spotify-text-gray);
            cursor: not-allowed;
            transform: scale(1);
        }

        .compare-all-btn {
            background: var(--spotify-green);
            color: var(--spotify-darker);
            border: none;
            padding: 14px 32px;
            border-radius: 500px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .compare-all-btn:hover {
            background: #2ebd59;
            transform: scale(1.05);
        }

        .compare-all-btn:disabled {
            background: var(--spotify-text-gray);
            cursor: not-allowed;
            transform: scale(1);
        }

        .file-card.dragging {
            opacity: 0.5;
            cursor: move;
        }

        .group-item.drag-over {
            background: var(--spotify-green);
            color: var(--spotify-darker);
            transform: translateX(8px);
        }

        .drop-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--spotify-green);
            display: none;
            z-index: 1000;
        }

        .drop-indicator.active {
            display: block;
        }

        .queue-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 90px;
            width: 300px;
            background: var(--spotify-gray);
            border-left: 1px solid var(--spotify-darker);
            transform: translateX(300px);
            transition: transform 0.3s;
            z-index: 500;
            display: flex;
            flex-direction: column;
        }

        .queue-panel.active {
            transform: translateX(0);
        }

        .queue-header {
            padding: 20px;
            border-bottom: 1px solid var(--spotify-darker);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--spotify-text);
        }

        .queue-close {
            background: transparent;
            border: none;
            color: var(--spotify-text);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .queue-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .queue-item {
            background: var(--spotify-light-gray);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-item:hover {
            background: var(--spotify-darker);
        }

        .queue-item.playing {
            border-left: 3px solid var(--spotify-green);
        }

        .queue-item-name {
            color: var(--spotify-text);
            font-weight: 600;
            font-size: 14px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .queue-item-remove {
            background: transparent;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 18px;
            padding: 0 4px;
        }

        .queue-toggle {
            position: fixed;
            right: 16px;
            bottom: 110px;
            background: var(--spotify-green);
            color: var(--spotify-darker);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 501;
            transition: all 0.2s;
        }

        .queue-toggle:hover {
            transform: scale(1.1);
            background: #2ebd59;
        }

        .success-message {
            background: var(--spotify-green);
            color: var(--spotify-darker);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .context-menu {
            position: fixed;
            background: var(--spotify-light-gray);
            border-radius: 4px;
            padding: 4px 0;
            box-shadow: 0 16px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            min-width: 160px;
        }

        .context-menu.active {
            display: block;
        }

        .context-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .context-item:hover {
            background: var(--spotify-gray);
        }

        .context-item.danger:hover {
            color: #ff4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--spotify-light-gray);
            padding: 32px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            background: var(--spotify-gray);
            border: 1px solid var(--spotify-text-gray);
            border-radius: 4px;
            color: var(--spotify-text);
            font-size: 16px;
            margin-bottom: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .no-results {
            text-align: center;
            color: var(--spotify-text-gray);
            padding: 40px;
            font-size: 14px;
        }
    </style>

    <!-- Schema.org JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "VoiceVerse",
        "applicationCategory": "MultimediaApplication",
        "description": "AI-powered text-to-speech application that converts text into natural, high-quality audio using advanced voice synthesis technology.",
        "url": "https://voiceverse.app",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "AI-powered text-to-speech conversion",
            "Multiple voice options",
            "Audio file management",
            "Group organization",
            "Voice comparison",
            "Character count and cost estimation",
            "Document upload support (TXT, DOCX, PDF)"
        ],
        "screenshot": "https://voiceverse.app/screenshot.png",
        "author": {
            "@type": "Organization",
            "name": "VoiceVerse"
        },
        "potentialAction": {
            "@type": "CreateAction",
            "target": {
                "@type": "EntryPoint",
                "urlTemplate": "https://voiceverse.app/",
                "actionPlatform": [
                    "http://schema.org/DesktopWebPlatform",
                    "http://schema.org/MobileWebPlatform"
                ]
            },
            "result": {
                "@type": "AudioObject",
                "name": "Generated Audio File"
            }
        }
    }
    </script>
</head>
<body>
    <div class="main-container">
        <nav class="sidebar" role="navigation" aria-label="Main navigation">
            <header class="logo">
                <h2>üåå VoiceVerse</h2>
            </header>

            <div class="nav-item active" onclick="showSection('home'); filterByGroup(null)" role="button" tabindex="0" aria-label="Navigate to home page">
                üè† Home
            </div>
            <div class="nav-item" onclick="showSection('create')" role="button" tabindex="0" aria-label="Navigate to create new audio">
                ‚ûï Create New
            </div>
            <div class="nav-item" onclick="showSection('compare')" role="button" tabindex="0" aria-label="Navigate to voice comparison">
                üé≠ Voice Comparison
            </div>

            {% if groups %}
            <section class="groups-section" aria-label="Audio file groups">
                <h3 class="groups-title">Groups</h3>
                {% for group_name, count in groups.items() %}
                <div class="group-item" onclick="filterByGroup('{{ group_name }}')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '{{ group_name }}')" data-group="{{ group_name }}" role="button" tabindex="0" aria-label="Filter by group: {{ group_name }}">
                    <span>üìÅ {{ group_name }}</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="group-count" aria-label="{{ count }} files">{{ count }}</span>
                        <button class="group-menu-btn" onclick="event.stopPropagation(); showGroupMenu(event, '{{ group_name }}')" aria-label="Group menu for {{ group_name }}">‚ãÆ</button>
                    </div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Playback History Section -->
            <section class="history-section" aria-label="Playback history">
                <div class="history-header">
                    <h3 class="history-title">Recent Plays</h3>
                    <button class="clear-history-btn" onclick="clearHistory()" aria-label="Clear playback history">Clear</button>
                </div>
                <div id="historyList" role="list" aria-live="polite">
                    <div class="no-history">No playback history yet</div>
                </div>
            </section>

            <a href="/logout" style="text-decoration: none;" aria-label="Logout from application">
                <div class="nav-item" style="background: rgba(235, 87, 87, 0.1); color: #ff6b6b;" role="button">
                    üö™ Logout
                </div>
            </a>

            <aside class="stats-card" aria-label="Usage statistics">
                <h3 class="sr-only">Usage Statistics</h3>
                <div class="stat-row">
                    <span class="stat-label">Total Files</span>
                    <span class="stat-value" aria-label="Total files generated: {{ usage.files_generated }}">{{ usage.files_generated }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Characters</span>
                    <span class="stat-value" aria-label="Total characters: {{ '{:,}'.format(usage.total_characters) }}">{{ "{:,}".format(usage.total_characters) }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Cost</span>
                    <span class="stat-value" aria-label="Total cost: ${{ '%.2f'|format(usage.total_cost) }}">${{ "%.2f"|format(usage.total_cost) }}</span>
                </div>
            </aside>
        </nav>

        <main class="main-content" id="main-content" role="main">
            <!-- Home Section -->
            <article id="homeSection" class="content-section" aria-labelledby="library-heading">
                <header class="header">
                    <h1 id="library-heading">Your Audio Library</h1>
                    <div style="display: flex; align-items: center; gap: 12px; justify-content: flex-end;">
                        <!-- Account Menu Button in Header -->
                        <button class="account-switcher-btn" onclick="showSwitchUserMenu()" aria-label="User menu for {{ session.username }}" aria-haspopup="dialog">
                            üë§ {{ session.username }}
                        </button>

                        <!-- User Selection Modal -->
                        <div id="switchUserMenu" role="dialog" aria-labelledby="switch-user-title" aria-modal="true" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--spotify-light-gray); border-radius: 12px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); z-index: 10000; min-width: 300px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 id="switch-user-title" style="margin: 0; color: var(--spotify-text);">Switch User</h3>
                                <button onclick="closeSwitchUserMenu()" aria-label="Close user menu" style="background: none; border: none; color: var(--spotify-text); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px;">√ó</button>
                            </div>
                            {% for user in all_users %}
                            <div class="account-option{% if user['username'] == session.username %} current{% endif %}"
                                 onclick="switchAccount('{{ user['username'] }}')">
                                <div class="account-option-label">
                                    <span>üë§</span>
                                    <span>{{ user['username'] }}</span>
                                    {% if user['username'] == session.username %}
                                    <span style="margin-left: auto; color: var(--spotify-green);">‚óè</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            <div class="add-account-btn" onclick="window.location.href='/register'" style="margin-top: 12px;">
                                + Add Account
                            </div>
                            <a href="/logout" style="text-decoration: none;">
                                <div class="add-account-btn" style="background: rgba(235, 87, 87, 0.1); color: #ff6b6b; border: none; margin-top: 8px;">
                                    üö™ Logout
                                </div>
                            </a>
                        </div>
                        <div id="switchUserOverlay" onclick="closeSwitchUserMenu()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;" aria-hidden="true"></div>
                        <label for="searchInput" class="sr-only">Search your audio files</label>
                        <input type="search" class="search-bar" placeholder="Search your files..." id="searchInput" onkeyup="filterFiles()" aria-label="Search audio files" role="searchbox">
                        <button class="btn-primary" onclick="showSection('create')" aria-label="Create new audio file">Create New</button>
                        <button class="settings-btn" onclick="window.location.href='/settings'" aria-label="Settings" title="Settings">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v6m0 6v6m5.196-15.196l-4.243 4.243m-5.906 5.906l-4.243 4.243m16.485 0l-4.243-4.243m-5.906-5.906l-4.243-4.243"></path>
                            </svg>
                        </button>
                    </div>
                </header>

                {% if success %}
                <div class="success-message" role="status" aria-live="polite">‚úÖ Audio generated successfully! Playing now...</div>
                {% endif %}

                {% if recent_files %}
                <section aria-labelledby="recent-files-heading">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="section-title" id="recent-files-heading" style="margin-bottom: 0;">Recent Files</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-secondary" onclick="selectAll()" style="padding: 8px 16px; font-size: 13px;" aria-label="Select all files">Select All</button>
                            <button class="btn-secondary" onclick="deselectAll()" style="padding: 8px 16px; font-size: 13px;" aria-label="Deselect all files">Deselect All</button>
                        </div>
                    </div>
                    <div class="files-grid" role="grid" aria-label="Audio files grid">
                    {% for file in recent_files %}
                    <article class="file-card" data-filename="{{ file.filename }}" data-name="{{ file.name }}" data-group="{{ file.group }}" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" aria-label="Audio file: {{ file.name }}">
                        <input type="checkbox" class="file-checkbox" onclick="event.stopPropagation(); toggleFileSelection('{{ file.filename }}', this)" aria-label="Select file {{ file.name }}">
                        <button class="file-card-options" onclick="event.stopPropagation(); showContextMenu(event, '{{ file.filename }}', '{{ file.name }}')" aria-label="Options for {{ file.name }}" aria-haspopup="menu">
                            ‚ãÆ
                        </button>
                        <button class="file-card-icon" onclick="playFile('{{ file.filename }}', '{{ file.name }}')" aria-label="Play {{ file.name }}">
                            üéµ
                            <div class="play-button" aria-hidden="true">‚ñ∂</div>
                        </button>
                        <h3 class="file-card-title">{{ file.name }}</h3>
                        <div class="file-card-meta" aria-label="File metadata">
                            <span aria-label="Group: {{ file.group }}">üìÅ {{ file.group }}</span><br>
                            <span aria-label="{{ file.chars }} characters, cost ${{ '%.3f'|format(file.cost) }}">{{ file.chars }} chars ‚Ä¢ ${{ "%.3f"|format(file.cost) }}</span>
                        </div>
                    </article>
                    {% endfor %}
                </div>
                </section>
                {% else %}
                <div class="no-results">
                    No audio files yet. Click "Create New" to get started!
                </div>
                {% endif %}
            </article>

            <!-- Create Section -->
            <div id="createSection" class="content-section" style="display: none;">
                <div class="header">
                    <h1>Create New Audio</h1>
                </div>

                {% if error %}
                <div class="error-message">{{ error }}</div>
                {% endif %}

                <form method="POST" action="/" style="max-width: 1200px;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 24px;">
                        <!-- Left Column: Main Form -->
                        <div>
                            <div class="form-group">
                                <label>File Name</label>
                                <input type="text" name="filename" id="filename" placeholder="My Awesome Audio" required maxlength="100">
                            </div>

                            <div class="form-group">
                                <label>Group</label>
                                <input type="text" name="group" id="group" placeholder="Work, Personal, Projects..." maxlength="50">
                                <small style="color: var(--spotify-text-gray); font-size: 12px; margin-top: 4px; display: block;">Leave empty for "Uncategorized"</small>
                            </div>

                            <div class="form-group">
                                <label>Text</label>
                                <textarea name="text" rows="12" placeholder="Enter your text here or upload a file..." id="textInput" required maxlength="50000"></textarea>
                                <div class="char-info">
                                    <span>Characters: <span id="charCount">0</span> / 50,000</span>
                                    <span class="cost-estimate">Est. cost: $<span id="costCount">0.000</span></span>
                                </div>
                                <div class="char-info" style="color: #ff9800; margin-top: 4px; font-size: 11px;">
                                    ‚ö†Ô∏è Note: OpenAI TTS limits each audio generation to 4,096 characters. Text will be truncated if longer.
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Voice</label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div class="voice-card" onclick="selectVoice('alloy', this)">
                                        <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('alloy', this)">üîä</button>
                                        <input type="radio" name="voice" value="alloy" style="display: none;">
                                        <div class="voice-name">Alloy</div>
                                        <div class="voice-desc">Neutral, balanced</div>
                                    </div>
                                    <div class="voice-card" onclick="selectVoice('echo', this)">
                                        <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('echo', this)">üîä</button>
                                        <input type="radio" name="voice" value="echo" style="display: none;">
                                        <div class="voice-name">Echo</div>
                                        <div class="voice-desc">Male, clear</div>
                                    </div>
                                    <div class="voice-card" onclick="selectVoice('fable', this)">
                                        <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('fable', this)">üîä</button>
                                        <input type="radio" name="voice" value="fable" style="display: none;">
                                        <div class="voice-name">Fable</div>
                                        <div class="voice-desc">British, expressive</div>
                                    </div>
                                    <div class="voice-card" onclick="selectVoice('onyx', this)">
                                        <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('onyx', this)">üîä</button>
                                        <input type="radio" name="voice" value="onyx" style="display: none;">
                                        <div class="voice-name">Onyx</div>
                                        <div class="voice-desc">Deep, authoritative</div>
                                    </div>
                                    <div class="voice-card selected" onclick="selectVoice('nova', this)">
                                        <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('nova', this)">üîä</button>
                                        <input type="radio" name="voice" value="nova" checked style="display: none;">
                                        <div class="voice-name">Nova</div>
                                        <div class="voice-desc">Female, friendly</div>
                                    </div>
                                    <div class="voice-card" onclick="selectVoice('shimmer', this)">
                                        <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('shimmer', this)">üîä</button>
                                        <input type="radio" name="voice" value="shimmer" style="display: none;">
                                        <div class="voice-name">Shimmer</div>
                                        <div class="voice-desc">Soft, warm</div>
                                    </div>
                                    <div class="voice-card voice-clone-card" onclick="showVoiceCloneModal()" style="grid-column: span 2; border: 2px dashed #bb86fc; background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 0, 130, 0.1)); padding: 12px 16px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                                        <span style="font-size: 24px;">üé§</span>
                                        <div>
                                            <div class="voice-name" style="color: #bb86fc; margin: 0;">Voice Clone</div>
                                            <div class="voice-desc" style="margin: 0;">Clone any voice with AI</div>
                                        </div>
                                        <span style="margin-left: auto; color: #bb86fc; font-size: 20px;">‚Üí</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Speech Speed</label>
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <input type="range" name="speed" id="speedSlider" min="0.25" max="4.0" step="0.25" value="1.0" style="flex: 1;" oninput="updateSpeedLabel(this.value)">
                                    <span id="speedLabel" style="color: var(--spotify-text); font-weight: 600; min-width: 60px;">1.0x</span>
                                </div>
                                <small style="color: var(--spotify-text-gray); font-size: 12px; margin-top: 4px; display: block;">
                                    Adjust playback speed (0.25x = very slow, 4.0x = very fast)
                                </small>
                            </div>

                            <!-- File Upload Area -->
                            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                                <div class="file-upload-icon">üìÑ</div>
                                <div class="file-upload-text">Click to upload or drag & drop</div>
                                <div class="file-upload-hint">Supports .txt, .docx, and .pdf files</div>
                            </div>
                            <input type="file" id="fileInput" accept=".txt,.docx,.pdf" style="display: none;" onchange="handleFileSelect(event)">

                            <!-- Uploaded File Info (hidden by default) -->
                            <div class="uploaded-file-info" id="uploadedFileInfo" style="display: none;">
                                <div class="uploaded-file-name">
                                    <span>üìÑ</span>
                                    <span id="uploadedFileName"></span>
                                </div>
                                <button type="button" class="remove-file-btn" onclick="removeUploadedFile()">‚úñ</button>
                            </div>

                            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px;">Generate Audio</button>
                        </div>

                        <!-- Right Column: AI Agents & Tips -->
                        <div>
                            <!-- AI Agent Features -->
                            <div style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 0, 130, 0.1)); padding: 16px; border-radius: 12px; border: 2px solid rgba(138, 43, 226, 0.3); margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">ü§ñ</span>
                            <label style="font-size: 16px; font-weight: 600; color: #bb86fc; margin: 0;">AI Agent Features</label>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- AI Preprocessing Toggle -->
                            <label class="ai-toggle-container">
                                <input type="checkbox" name="use_preprocessing" id="usePreprocessing">
                                <span class="ai-toggle-label">
                                    <span style="font-weight: 600;">‚ú® Smart Text Preprocessing</span>
                                    <small style="display: block; color: var(--spotify-text-gray); margin-top: 4px;">
                                        AI cleans text, fixes formatting, expands URLs/acronyms for better speech quality
                                    </small>
                                </span>
                            </label>

                            <!-- Smart Chunking Toggle -->
                            <label class="ai-toggle-container">
                                <input type="checkbox" name="use_chunking" id="useChunking">
                                <span class="ai-toggle-label">
                                    <span style="font-weight: 600;">‚úÇÔ∏è Smart Chunking (4096+ chars)</span>
                                    <small style="display: block; color: var(--spotify-text-gray); margin-top: 4px;">
                                        AI splits long text at natural boundaries instead of truncating
                                    </small>
                                </span>
                            </label>

                            <!-- AI Suggestions Button -->
                            <button type="button" class="ai-suggest-btn" onclick="getAISuggestions()" id="aiSuggestBtn">
                                <span>üí°</span>
                                <span>Get AI Suggestions</span>
                                <small style="display: block; font-size: 11px; opacity: 0.8; font-weight: normal;">Auto-fill filename, category & voice</small>
                            </button>

                            <!-- Text Analysis Button -->
                            <button type="button" class="ai-analyze-btn" onclick="analyzeText()" id="aiAnalyzeBtn">
                                <span>üìä</span>
                                <span>Analyze Text Quality</span>
                                <small style="display: block; font-size: 11px; opacity: 0.8; font-weight: normal;">Check for issues & get recommendations</small>
                            </button>
                        </div>

                                <!-- Analysis Results Area -->
                                <div id="analysisResults" style="display: none; margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid #bb86fc;">
                                    <div id="analysisContent"></div>
                                </div>
                            </div>

                            <!-- Natural Speech Tips (Right Sidebar) -->
                            <div style="background: var(--spotify-light-gray); padding: 12px; border-radius: 8px; border-left: 3px solid var(--spotify-green);">
                                <div style="font-weight: 600; color: var(--spotify-text); margin-bottom: 8px; font-size: 14px;">üí° Natural Speech Tips</div>
                                <ul style="color: var(--spotify-text-gray); font-size: 11px; margin: 0; padding-left: 16px; line-height: 1.8;">
                                    <li><strong>... (ellipsis)</strong> - natural pauses</li>
                                    <li><strong>, (commas)</strong> - brief pauses</li>
                                    <li><strong>‚Äî (dashes)</strong> - longer breaks</li>
                                    <li><strong>ALL CAPS</strong> - emphasis</li>
                                    <li><strong>? (questions)</strong> - rising tone</li>
                                    <li><strong>! (exclamation)</strong> - excitement</li>
                                </ul>
                            </div>

                            <!-- Voice Selection Guide -->
                            <div style="background: var(--spotify-light-gray); padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #1e90ff;">
                                <div style="font-weight: 600; color: var(--spotify-text); margin-bottom: 8px; font-size: 14px;">üé≠ Voice Guide</div>
                                <ul style="color: var(--spotify-text-gray); font-size: 11px; margin: 0; padding-left: 16px; line-height: 1.6;">
                                    <li><strong>Alloy:</strong> Neutral, tutorials</li>
                                    <li><strong>Echo:</strong> Technical, professional</li>
                                    <li><strong>Fable:</strong> Storytelling, audiobooks</li>
                                    <li><strong>Onyx:</strong> Authority, news</li>
                                    <li><strong>Nova:</strong> Friendly, guides</li>
                                    <li><strong>Shimmer:</strong> Soothing, calm</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Voice Comparison Section -->
            <div id="compareSection" class="content-section" style="display: none;">
            <div class="header">
                <h1>üé≠ Voice Comparison</h1>
            </div>

            <div style="max-width: 800px; margin-bottom: 32px;">
                <p style="color: var(--spotify-text-gray); margin-bottom: 16px;">
                    Enter custom text below and hear it spoken by all available voices. This helps you choose the perfect voice for your content.
                </p>

                <div class="form-group">
                    <label>Sample Text</label>
                    <textarea id="comparisonText" rows="4" placeholder="Enter text to compare voices (e.g., 'Hello, welcome to our podcast about technology and innovation.')" maxlength="500" style="width: 100%; padding: 12px; background: var(--spotify-gray); border: 1px solid var(--spotify-light-gray); border-radius: 4px; color: var(--spotify-text); font-size: 14px; resize: vertical;"></textarea>
                    <div class="char-info">
                        <span>Characters: <span id="comparisonCharCount">0</span> / 500</span>
                    </div>
                </div>

                <button class="compare-all-btn" onclick="compareAllVoices()" id="compareAllBtn">
                    üéµ Compare All Voices
                </button>
            </div>

            <div class="comparison-grid">
                <div class="comparison-card" id="card-alloy">
                    <div class="comparison-voice-name">Alloy</div>
                    <div class="comparison-voice-desc">Neutral, balanced</div>
                    <button class="comparison-play-btn" onclick="playComparison('alloy')" id="btn-alloy">
                        <span>‚ñ∂</span>
                        <span>Play</span>
                    </button>
                </div>

                <div class="comparison-card" id="card-echo">
                    <div class="comparison-voice-name">Echo</div>
                    <div class="comparison-voice-desc">Male, clear</div>
                    <button class="comparison-play-btn" onclick="playComparison('echo')" id="btn-echo">
                        <span>‚ñ∂</span>
                        <span>Play</span>
                    </button>
                </div>

                <div class="comparison-card" id="card-fable">
                    <div class="comparison-voice-name">Fable</div>
                    <div class="comparison-voice-desc">British, expressive</div>
                    <button class="comparison-play-btn" onclick="playComparison('fable')" id="btn-fable">
                        <span>‚ñ∂</span>
                        <span>Play</span>
                    </button>
                </div>

                <div class="comparison-card" id="card-onyx">
                    <div class="comparison-voice-name">Onyx</div>
                    <div class="comparison-voice-desc">Deep, authoritative</div>
                    <button class="comparison-play-btn" onclick="playComparison('onyx')" id="btn-onyx">
                        <span>‚ñ∂</span>
                        <span>Play</span>
                    </button>
                </div>

                <div class="comparison-card" id="card-nova">
                    <div class="comparison-voice-name">Nova</div>
                    <div class="comparison-voice-desc">Female, friendly</div>
                    <button class="comparison-play-btn" onclick="playComparison('nova')" id="btn-nova">
                        <span>‚ñ∂</span>
                        <span>Play</span>
                    </button>
                </div>

                <div class="comparison-card" id="card-shimmer">
                    <div class="comparison-voice-name">Shimmer</div>
                    <div class="comparison-voice-desc">Soft, warm</div>
                    <button class="comparison-play-btn" onclick="playComparison('shimmer')" id="btn-shimmer">
                        <span>‚ñ∂</span>
                        <span>Play</span>
                    </button>
                </div>
            </div>
        </div>
        </main>
    </div>

    <!-- Queue Toggle Button -->
    <button class="queue-toggle" onclick="toggleQueue()" title="Queue">
        üéµ
    </button>

    <!-- Queue Panel -->
    <div class="queue-panel" id="queuePanel">
        <div class="queue-header">
            <div class="queue-title">Queue (<span id="queueCount">0</span>)</div>
            <button class="queue-close" onclick="toggleQueue()">√ó</button>
        </div>
        <div class="queue-actions" style="padding: 10px; display: flex; gap: 8px; border-bottom: 1px solid var(--spotify-light-gray);">
            <button class="queue-btn" onclick="saveQueueAsPlaylist()" title="Save Queue as Playlist" style="flex: 1; padding: 8px; background: var(--spotify-green); border: none; color: var(--spotify-darker); border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                üíæ Save Playlist
            </button>
            <button class="queue-btn" onclick="openPlaylistManager()" title="Manage Playlists" style="flex: 1; padding: 8px; background: var(--spotify-gray); border: 1px solid var(--spotify-light-gray); color: var(--spotify-text); border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                üìã Playlists
            </button>
        </div>
        <div class="queue-list" id="queueList">
            <div style="color: var(--spotify-text-gray); text-align: center; padding: 40px 20px;">
                Queue is empty. Right-click files and select "Add to Queue"
            </div>
        </div>
    </div>

    <!-- Bulk Toggle Button -->
    <button class="bulk-toggle-btn" id="bulkToggleBtn" onclick="toggleBulkMenu()">
        <span id="bulkToggleCount">0 selected</span>
        <span>‚ñº</span>
    </button>

    <!-- Bulk Action Bar -->
    <div class="bulk-action-bar" id="bulkActionBar">
        <div class="bulk-count" id="bulkCount">0 selected</div>
        <button class="bulk-btn" onclick="bulkMoveToGroup()">üìÅ Move to Group</button>
        <button class="bulk-btn danger" onclick="bulkDelete()">üóëÔ∏è Delete Selected</button>
        <button class="bulk-btn" onclick="deselectAll()">‚úñÔ∏è Cancel</button>
    </div>

    <!-- AI Suggestions Review Modal -->
    <div class="group-select-modal" id="aiSuggestionsModal" onclick="if(event.target === this) closeAISuggestionsModal()" style="display: none;">
        <div class="group-select-content" style="max-width: 500px;">
            <div class="group-select-header">
                <h3>ü§ñ Review AI Suggestions</h3>
                <button class="group-select-close" onclick="closeAISuggestionsModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <p style="color: var(--spotify-text-gray); font-size: 14px; margin-bottom: 16px;">
                        Review and select which suggestions to apply:
                    </p>
                </div>

                <!-- Filename Suggestion -->
                <div id="filenameSuggestion" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--spotify-light-gray); border-radius: 8px;">
                    <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="acceptFilename" checked style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--spotify-green);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Filename</div>
                            <div style="color: var(--spotify-text-gray); font-size: 13px;" id="filenameSuggestionText"></div>
                        </div>
                    </label>
                </div>

                <!-- Category Suggestion -->
                <div id="categorySuggestion" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--spotify-light-gray); border-radius: 8px;">
                    <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="acceptCategory" checked style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--spotify-green);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Category</div>
                            <div style="color: var(--spotify-text-gray); font-size: 13px;" id="categorySuggestionText"></div>
                        </div>
                    </label>
                </div>

                <!-- Voice Suggestion -->
                <div id="voiceSuggestion" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--spotify-light-gray); border-radius: 8px;">
                    <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="acceptVoice" checked style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--spotify-green);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Voice</div>
                            <div style="color: var(--spotify-text-gray); font-size: 13px;" id="voiceSuggestionText"></div>
                        </div>
                    </label>
                </div>

                <!-- Summary -->
                <div style="margin-bottom: 20px; padding: 12px; background: rgba(138, 43, 226, 0.1); border-radius: 8px; border-left: 3px solid #bb86fc;">
                    <div style="font-weight: 600; margin-bottom: 4px; font-size: 13px; color: #bb86fc;">Summary</div>
                    <div style="color: var(--spotify-text-gray); font-size: 12px; line-height: 1.6;" id="summarySuggestionText"></div>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button class="btn-primary" onclick="applySelectedSuggestions()" style="flex: 1;">
                        Apply Selected
                    </button>
                    <button class="btn-secondary" onclick="closeAISuggestionsModal()" style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Selection Modal -->
    <div class="group-select-modal" id="groupSelectModal" onclick="if(event.target === this) closeGroupSelectModal()">
        <div class="group-select-content">
            <div class="group-select-title">Move to Group</div>
            <div id="groupSelectList"></div>
            <button class="group-select-cancel" onclick="closeGroupSelectModal()">Cancel</button>
        </div>
    </div>

    <!-- Playlist Manager Modal -->
    <div class="group-select-modal" id="playlistManagerModal" onclick="if(event.target === this) closePlaylistManager()" style="display: none;">
        <div class="group-select-content" style="max-width: 600px; max-height: 80vh;">
            <div class="group-select-header">
                <h3>üìã Playlist Manager</h3>
                <button class="group-select-close" onclick="closePlaylistManager()">√ó</button>
            </div>
            <div style="padding: 20px; overflow-y: auto; max-height: calc(80vh - 140px);">
                <div id="playlistsList" style="display: grid; gap: 12px;">
                    <div style="text-align: center; color: var(--spotify-text-gray); padding: 40px 20px;">
                        No playlists yet. Save your current queue to create one!
                    </div>
                </div>
            </div>
            <div style="padding: 0 20px 20px 20px; display: flex; gap: 12px; border-top: 1px solid var(--spotify-light-gray); padding-top: 16px;">
                <button class="btn-primary" onclick="exportAllPlaylists()" style="flex: 1;">
                    üì§ Export All
                </button>
                <button class="btn-primary" onclick="document.getElementById('playlistImportFile').click()" style="flex: 1;">
                    üì• Import
                </button>
                <input type="file" id="playlistImportFile" accept=".json" style="display: none;" onchange="importPlaylists(event)">
            </div>
        </div>
    </div>

    <!-- Player Bar -->
    <div class="player-bar">
        <div class="now-playing" id="nowPlaying" style="opacity: 0.5;">
            <div class="now-playing-art">üéµ</div>
            <div class="now-playing-info">
                <h4 id="currentTrackName">No track playing</h4>
                <p id="currentTrackInfo">Select a file to play</p>
            </div>
        </div>

        <div class="player-controls">
            <div class="control-buttons">
                <button class="control-btn" onclick="toggleShuffle()" id="shuffleBtn" title="Shuffle Off">üîÄ</button>
                <button class="control-btn" onclick="toggleRepeat()" id="repeatBtn" title="No Repeat">üîÅ</button>
                <button class="control-btn" onclick="skipBackward()" id="backBtn" title="Previous / Restart">‚èÆ</button>
                <button class="control-btn play" onclick="togglePlay()" id="playBtn">‚ñ∂</button>
                <button class="control-btn" onclick="skipForward()" id="forwardBtn" title="Next Track">‚è≠</button>
            </div>
            <div class="progress-bar">
                <span id="currentTime">0:00</span>
                <div class="progress-track" onclick="seekTo(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span id="totalTime">0:00</span>
            </div>
        </div>

        <div class="volume-controls">
            <span>üîä</span>
            <div class="volume-slider" onclick="setVolume(event)">
                <div class="volume-fill" id="volumeFill"></div>
            </div>
        </div>
    </div>

    <!-- Context Menu for Files -->
    <div class="context-menu" id="contextMenu">
        <div class="context-item" onclick="contextPlay()">‚ñ∂ Play</div>
        <div class="context-item" onclick="contextAddToQueue()">üéµ Add to Queue</div>
        <div class="context-item" onclick="contextRename()">‚úè Rename</div>
        <div class="context-item" onclick="contextDownload()">‚¨á Download</div>
        <div class="context-item danger" onclick="contextDelete()">üóë Delete</div>
    </div>

    <!-- Context Menu for Groups -->
    <div class="context-menu" id="groupContextMenu">
        <div class="context-item" onclick="groupContextRename()">‚úè Rename Group</div>
        <div class="context-item danger" onclick="groupContextDelete()">üóë Delete Group</div>
    </div>

    <!-- Rename File Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">Rename File</div>
            <input type="text" class="modal-input" id="renameInput" placeholder="New file name" maxlength="100">
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmRename()">Rename</button>
            </div>
        </div>
    </div>

    <!-- Rename Group Modal -->
    <div class="modal" id="renameGroupModal">
        <div class="modal-content">
            <div class="modal-header">Rename Group</div>
            <input type="text" class="modal-input" id="renameGroupInput" placeholder="New group name" maxlength="50">
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmGroupRename()">Rename</button>
            </div>
        </div>
    </div>

    <!-- Voice Clone Modal -->
    <div class="modal" id="voiceCloneModal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="color: #bb86fc; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 24px; margin-right: 8px;">üé§</span>
                    Voice Cloning
                </div>
                <button onclick="closeVoiceCloneModal()" style="background: none; border: none; color: var(--spotify-text-gray); cursor: pointer; font-size: 20px;">‚úï</button>
            </div>

            <!-- Main View: List of Cloned Voices -->
            <div id="voiceCloneListView" style="padding: 16px 0;">
                <p style="color: var(--spotify-text-gray); margin-bottom: 16px; font-size: 14px;">
                    Select a cloned voice to use, or create a new one.
                </p>

                <!-- Cloned Voices Grid -->
                <div id="clonedVoicesGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; max-height: 250px; overflow-y: auto;">
                    <!-- Cloned voices will be loaded here dynamically -->
                    <div style="grid-column: span 2; text-align: center; padding: 24px; color: var(--spotify-text-gray);">
                        <div style="font-size: 32px; margin-bottom: 8px;">üîç</div>
                        <div>Loading voices...</div>
                    </div>
                </div>

                <!-- Clone New Voice Button -->
                <button onclick="showCloneNewVoiceView()" style="width: 100%; padding: 14px; border: 2px dashed #bb86fc; border-radius: 12px; background: rgba(138, 43, 226, 0.05); color: #bb86fc; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                    <span style="font-size: 20px;">‚ûï</span>
                    Clone New Voice
                </button>
            </div>

            <!-- Clone New Voice View (hidden by default) -->
            <div id="voiceCloneUploadView" style="display: none; padding: 16px 0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                    <button onclick="showVoiceListView()" style="background: none; border: none; color: #bb86fc; cursor: pointer; font-size: 18px;">‚Üê</button>
                    <span style="color: var(--spotify-text); font-weight: 600;">Clone New Voice</span>
                </div>

                <p style="color: var(--spotify-text-gray); margin-bottom: 16px; font-size: 14px;">
                    Upload a voice sample (3-10 seconds of clear speech) to clone any voice.
                </p>

                <!-- Voice Name Input -->
                <div style="margin-bottom: 16px;">
                    <label style="color: var(--spotify-text); font-size: 14px; margin-bottom: 8px; display: block;">Voice Name</label>
                    <input type="text" id="newVoiceName" placeholder="e.g., My Voice, Morgan Freeman..." style="width: 100%; padding: 10px 12px; border-radius: 8px; background: var(--spotify-light-gray); color: var(--spotify-text); border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box;">
                </div>

                <!-- Voice Sample Upload -->
                <div id="voiceSampleUploadArea" style="border: 2px dashed #bb86fc; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; background: rgba(138, 43, 226, 0.05); transition: all 0.3s;" onclick="document.getElementById('voiceSampleInput').click()">
                    <div style="font-size: 32px; margin-bottom: 8px;">üéôÔ∏è</div>
                    <div style="color: #bb86fc; font-weight: 600;">Click to upload voice sample</div>
                    <div style="color: var(--spotify-text-gray); font-size: 12px; margin-top: 4px;">WAV or MP3, 3-10 seconds recommended</div>
                </div>
                <input type="file" id="voiceSampleInput" accept=".wav,.mp3,.m4a,.ogg" style="display: none;" onchange="handleVoiceSampleUpload(event)">

                <!-- Uploaded Sample Info -->
                <div id="voiceSampleInfo" style="display: none; margin-top: 12px; padding: 12px; background: rgba(138, 43, 226, 0.1); border-radius: 8px; border-left: 3px solid #bb86fc;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #bb86fc;">‚úì</span>
                            <span id="voiceSampleName" style="color: var(--spotify-text); margin-left: 8px;"></span>
                        </div>
                        <button type="button" onclick="removeVoiceSample()" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 16px;">‚úñ</button>
                    </div>
                </div>

                <!-- Save & Use Button -->
                <button onclick="saveAndUseClonedVoice()" id="saveClonedVoiceBtn" style="width: 100%; margin-top: 16px; padding: 14px; border: none; border-radius: 12px; background: linear-gradient(135deg, #bb86fc, #8b5cf6); color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    Save & Use This Voice
                </button>
            </div>

            <!-- Bottom buttons for list view -->
            <div id="voiceCloneListButtons" class="modal-buttons">
                <button class="btn-secondary" onclick="closeVoiceCloneModal()">Cancel</button>
                <button class="btn-primary" id="useSelectedVoiceBtn" onclick="useSelectedClonedVoice()" style="background: linear-gradient(135deg, #bb86fc, #8b5cf6);" disabled>Use Selected Voice</button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" style="display: none;"></audio>

    <script>
        let currentFilename = null;
        let currentFileName = null;
        let currentGroupName = null;
        const audioPlayer = document.getElementById('audioPlayer');
        let previewAudio = null;
        let isPreviewPlaying = false;

        // Repeat modes: 0 = no repeat, 1 = repeat one, 2 = repeat all (future queue feature)
        let repeatMode = parseInt(localStorage.getItem('repeatMode')) || 0;

        // Shuffle mode
        let shuffleMode = localStorage.getItem('shuffleMode') === 'true' || false;

        // Account switcher functions
        function showSwitchUserMenu() {
            document.getElementById('switchUserMenu').style.display = 'block';
            document.getElementById('switchUserOverlay').style.display = 'block';
        }

        function closeSwitchUserMenu() {
            document.getElementById('switchUserMenu').style.display = 'none';
            document.getElementById('switchUserOverlay').style.display = 'none';
        }

        function switchAccount(username) {
            window.location.href = '/switch-account/' + encodeURIComponent(username);
        }

        // Character counter
        const textInput = document.getElementById('textInput');
        if (textInput) {
            textInput.addEventListener('input', function() {
                const length = this.value.length;
                document.getElementById('charCount').textContent = length.toLocaleString();
                const cost = (length / 1000) * 0.015;
                document.getElementById('costCount').textContent = cost.toFixed(4);
            });
        }

        // Voice selection
        function selectVoice(voice, element) {
            document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
        }

        // Voice preview
        async function previewVoice(voice, button) {
            // Prevent multiple simultaneous previews
            if (isPreviewPlaying) {
                if (previewAudio) {
                    previewAudio.pause();
                    previewAudio = null;
                }
                document.querySelectorAll('.voice-preview-btn').forEach(btn => {
                    btn.classList.remove('loading', 'playing');
                    btn.textContent = 'üîä';
                });
                isPreviewPlaying = false;
                return;
            }

            // Set loading state
            button.classList.add('loading');
            button.textContent = '‚è≥';
            isPreviewPlaying = true;

            // Disable all other preview buttons
            document.querySelectorAll('.voice-preview-btn').forEach(btn => {
                if (btn !== button) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                }
            });

            try {
                const response = await fetch(`/preview/${voice}`);

                if (!response.ok) {
                    throw new Error('Failed to generate preview');
                }

                const blob = await response.blob();
                const audioUrl = URL.createObjectURL(blob);

                previewAudio = new Audio(audioUrl);

                // Update button state when playing
                previewAudio.onplay = () => {
                    button.classList.remove('loading');
                    button.classList.add('playing');
                    button.textContent = '‚è∏';
                };

                // Clean up when preview ends
                previewAudio.onended = () => {
                    button.classList.remove('playing');
                    button.textContent = 'üîä';
                    URL.revokeObjectURL(audioUrl);
                    previewAudio = null;
                    isPreviewPlaying = false;

                    // Re-enable all buttons
                    document.querySelectorAll('.voice-preview-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                };

                // Handle errors during playback
                previewAudio.onerror = () => {
                    button.classList.remove('loading', 'playing');
                    button.textContent = 'üîä';
                    URL.revokeObjectURL(audioUrl);
                    previewAudio = null;
                    isPreviewPlaying = false;

                    // Re-enable all buttons
                    document.querySelectorAll('.voice-preview-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                    alert('Error playing preview');
                };

                await previewAudio.play();

            } catch (error) {
                console.error('Preview error:', error);
                button.classList.remove('loading', 'playing');
                button.textContent = 'üîä';
                isPreviewPlaying = false;

                // Re-enable all buttons
                document.querySelectorAll('.voice-preview-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
                alert('Failed to load voice preview. Please try again.');
            }
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const sections = {
                'home': 0,
                'create': 1,
                'compare': 2
            };

            document.getElementById(section + 'Section').style.display = 'block';
            document.querySelectorAll('.nav-item')[sections[section]].classList.add('active');
        }

        // Context Menu
        function showContextMenu(event, filename, name) {
            event.preventDefault();
            event.stopPropagation();

            currentFilename = filename;
            currentFileName = name;

            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('active');
        }

        document.addEventListener('click', () => {
            document.getElementById('contextMenu').classList.remove('active');
            document.getElementById('groupContextMenu').classList.remove('active');
        });

        // Group Context Menu
        function showGroupMenu(event, groupName) {
            event.preventDefault();
            event.stopPropagation();

            currentGroupName = groupName;

            const menu = document.getElementById('groupContextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('active');
        }

        function groupContextRename() {
            document.getElementById('renameGroupInput').value = currentGroupName;
            document.getElementById('renameGroupModal').classList.add('active');
        }

        function groupContextDelete() {
            if (confirm(`Delete group "${currentGroupName}" and all its files?`)) {
                fetch(`/delete-group/${encodeURIComponent(currentGroupName)}`, {method: 'POST'})
                    .then(response => {
                        if (response.ok) window.location.reload();
                        else alert('Failed to delete group');
                    })
                    .catch(err => alert('Error: ' + err));
            }
        }

        function confirmGroupRename() {
            const newName = document.getElementById('renameGroupInput').value.trim();
            if (newName && newName !== currentGroupName) {
                fetch(`/rename-group/${encodeURIComponent(currentGroupName)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: newName})
                }).then(response => {
                    if (response.ok) window.location.reload();
                    else alert('Failed to rename group');
                }).catch(err => alert('Error: ' + err));
            }
            closeModal();
        }

        // File Context Menu
        function contextPlay() {
            playFile(currentFilename, currentFileName);
        }

        function contextRename() {
            document.getElementById('renameInput').value = currentFileName;
            document.getElementById('renameModal').classList.add('active');
        }

        function contextDownload() {
            window.location.href = `/download/${encodeURIComponent(currentFilename)}`;
        }

        function contextDelete() {
            if (confirm(`Delete "${currentFileName}"?`)) {
                fetch(`/delete/${encodeURIComponent(currentFilename)}`, {method: 'POST'})
                    .then(response => {
                        if (response.ok) window.location.reload();
                        else alert('Failed to delete file');
                    })
                    .catch(err => alert('Error: ' + err));
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        // ========== VOICE CLONING FUNCTIONS ==========
        let currentVoiceSample = null;
        let selectedClonedVoice = null;
        let voiceCloneActive = false;
        let pendingUploadFile = null;

        function showVoiceCloneModal() {
            // Reset to list view
            showVoiceListView();
            // Load existing cloned voices
            loadClonedVoices();
            document.getElementById('voiceCloneModal').classList.add('active');
        }

        function closeVoiceCloneModal() {
            document.getElementById('voiceCloneModal').classList.remove('active');
            // Reset state
            selectedClonedVoice = null;
            pendingUploadFile = null;
            document.getElementById('useSelectedVoiceBtn').disabled = true;
        }

        function showVoiceListView() {
            document.getElementById('voiceCloneListView').style.display = 'block';
            document.getElementById('voiceCloneUploadView').style.display = 'none';
            document.getElementById('voiceCloneListButtons').style.display = 'flex';
        }

        function showCloneNewVoiceView() {
            document.getElementById('voiceCloneListView').style.display = 'none';
            document.getElementById('voiceCloneUploadView').style.display = 'block';
            document.getElementById('voiceCloneListButtons').style.display = 'none';
            // Reset upload form
            document.getElementById('newVoiceName').value = '';
            document.getElementById('voiceSampleInfo').style.display = 'none';
            document.getElementById('voiceSampleInput').value = '';
            pendingUploadFile = null;
        }

        async function loadClonedVoices() {
            const grid = document.getElementById('clonedVoicesGrid');
            grid.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 24px; color: var(--spotify-text-gray);"><div style="font-size: 32px; margin-bottom: 8px;">üîç</div><div>Loading voices...</div></div>';

            try {
                const response = await fetch('/api/voice-clone/samples');
                const data = await response.json();

                if (data.samples && data.samples.length > 0) {
                    grid.innerHTML = '';
                    data.samples.forEach(sample => {
                        const card = document.createElement('div');
                        card.className = 'cloned-voice-card';
                        card.dataset.sampleId = sample.filename;
                        card.dataset.sampleName = sample.name || 'Cloned Voice';
                        card.onclick = () => selectClonedVoice(sample.filename, sample.name || 'Cloned Voice', card);
                        card.style.cssText = 'padding: 16px; border-radius: 12px; background: var(--spotify-light-gray); border: 2px solid transparent; cursor: pointer; transition: all 0.3s; text-align: center;';
                        card.innerHTML = `
                            <div style="font-size: 28px; margin-bottom: 8px;">üé§</div>
                            <div style="color: var(--spotify-text); font-weight: 600; font-size: 14px;">${sample.name || 'Cloned Voice'}</div>
                            <div style="color: var(--spotify-text-gray); font-size: 11px; margin-top: 4px;">${sample.filename}</div>
                        `;
                        grid.appendChild(card);
                    });
                } else {
                    grid.innerHTML = `
                        <div style="grid-column: span 2; text-align: center; padding: 32px; color: var(--spotify-text-gray);">
                            <div style="font-size: 48px; margin-bottom: 12px;">üéôÔ∏è</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">No cloned voices yet</div>
                            <div style="font-size: 13px;">Click "Clone New Voice" to create your first one!</div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load cloned voices:', err);
                grid.innerHTML = `
                    <div style="grid-column: span 2; text-align: center; padding: 24px; color: var(--spotify-text-gray);">
                        <div style="font-size: 32px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                        <div>Failed to load voices</div>
                    </div>
                `;
            }
        }

        let selectedClonedVoiceName = null;

        function selectClonedVoice(sampleId, sampleName, card) {
            // Deselect all cards
            document.querySelectorAll('.cloned-voice-card').forEach(c => {
                c.style.border = '2px solid transparent';
            });
            // Select this card
            card.style.border = '2px solid #bb86fc';
            selectedClonedVoice = sampleId;
            selectedClonedVoiceName = sampleName;
            document.getElementById('useSelectedVoiceBtn').disabled = false;
        }

        function useSelectedClonedVoice() {
            if (!selectedClonedVoice) {
                alert('Please select a cloned voice first');
                return;
            }
            activateVoiceCloneWithSample(selectedClonedVoice, selectedClonedVoiceName);
        }

        async function handleVoiceSampleUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            pendingUploadFile = file;
            document.getElementById('voiceSampleName').textContent = file.name;
            document.getElementById('voiceSampleInfo').style.display = 'block';
        }

        function removeVoiceSample() {
            pendingUploadFile = null;
            document.getElementById('voiceSampleInfo').style.display = 'none';
            document.getElementById('voiceSampleInput').value = '';
        }

        async function saveAndUseClonedVoice() {
            const voiceName = document.getElementById('newVoiceName').value.trim();
            if (!pendingUploadFile) {
                alert('Please upload a voice sample first');
                return;
            }
            if (!voiceName) {
                alert('Please enter a name for this voice');
                return;
            }

            const formData = new FormData();
            formData.append('voice_sample', pendingUploadFile);
            formData.append('voice_name', voiceName);

            // Get CSRF token from the page form
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
            if (csrfToken) {
                formData.append('csrf_token', csrfToken);
            }

            try {
                document.getElementById('saveClonedVoiceBtn').textContent = 'Saving...';
                document.getElementById('saveClonedVoiceBtn').disabled = true;

                const response = await fetch('/api/voice-clone/upload-sample', {
                    method: 'POST',
                    body: formData,
                    headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {}
                });

                const data = await response.json();

                if (response.ok) {
                    // Activate this voice immediately with the name from the upload response
                    activateVoiceCloneWithSample(data.filename, data.name);
                } else {
                    alert(data.error || 'Failed to save voice');
                    document.getElementById('saveClonedVoiceBtn').textContent = 'Save & Use This Voice';
                    document.getElementById('saveClonedVoiceBtn').disabled = false;
                }
            } catch (err) {
                console.error('Upload error:', err);
                alert('Failed to save voice sample');
                document.getElementById('saveClonedVoiceBtn').textContent = 'Save & Use This Voice';
                document.getElementById('saveClonedVoiceBtn').disabled = false;
            }
        }

        function activateVoiceCloneWithSample(sampleId, sampleName) {
            currentVoiceSample = sampleId;
            voiceCloneActive = true;
            localStorage.setItem('useVoiceClone', 'true');
            localStorage.setItem('voiceSampleFilename', sampleId);
            localStorage.setItem('voiceSampleName', sampleName || 'Cloned Voice');

            // Update UI to show voice clone is active with the voice name
            const voiceCloneCard = document.querySelector('.voice-clone-card');
            if (voiceCloneCard) {
                voiceCloneCard.style.border = '2px solid #1DB954';
                voiceCloneCard.style.background = 'linear-gradient(135deg, rgba(29, 185, 84, 0.2), rgba(30, 215, 96, 0.1))';
                const voiceNameEl = voiceCloneCard.querySelector('.voice-name');
                if (voiceNameEl) voiceNameEl.textContent = (sampleName || 'Cloned Voice') + ' ‚úì';
            }

            // Deselect other voices
            document.querySelectorAll('.voice-card:not(.voice-clone-card)').forEach(card => {
                card.classList.remove('selected');
            });

            closeVoiceCloneModal();
        }

        function deactivateVoiceClone() {
            voiceCloneActive = false;
            currentVoiceSample = null;
            localStorage.removeItem('useVoiceClone');
            localStorage.removeItem('voiceSampleFilename');
            localStorage.removeItem('voiceSampleName');

            const voiceCloneCard = document.querySelector('.voice-clone-card');
            if (voiceCloneCard) {
                voiceCloneCard.style.border = '2px dashed #bb86fc';
                voiceCloneCard.style.background = 'linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 0, 130, 0.1))';
                const voiceNameEl = voiceCloneCard.querySelector('.voice-name');
                if (voiceNameEl) voiceNameEl.textContent = 'Voice Clone';
            }
        }

        // Check if voice clone was active on page load
        if (localStorage.getItem('useVoiceClone') === 'true') {
            const storedSample = localStorage.getItem('voiceSampleFilename');
            const storedName = localStorage.getItem('voiceSampleName') || 'Cloned Voice';
            if (storedSample) {
                currentVoiceSample = storedSample;
                voiceCloneActive = true;
                // Update UI on load with stored voice name
                setTimeout(() => {
                    const voiceCloneCard = document.querySelector('.voice-clone-card');
                    if (voiceCloneCard) {
                        voiceCloneCard.style.border = '2px solid #1DB954';
                        voiceCloneCard.style.background = 'linear-gradient(135deg, rgba(29, 185, 84, 0.2), rgba(30, 215, 96, 0.1))';
                        const voiceNameEl = voiceCloneCard.querySelector('.voice-name');
                        if (voiceNameEl) voiceNameEl.textContent = storedName + ' ‚úì';
                    }
                }, 100);
            }
        }
        // ========== END VOICE CLONING FUNCTIONS ==========

        function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (newName && newName !== currentFileName) {
                fetch(`/rename/${encodeURIComponent(currentFilename)}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: newName})
                }).then(response => {
                    if (response.ok) window.location.reload();
                    else alert('Failed to rename file');
                }).catch(err => alert('Error: ' + err));
            }
            closeModal();
        }

        // Player functions
        function playFile(filename, displayName) {
            if (!filename) return;

            audioPlayer.src = `/audio/${encodeURIComponent(filename)}`;
            audioPlayer.play().catch(e => {
                console.error('Playback error:', e);
                alert('Failed to play audio');
            });

            document.getElementById('nowPlaying').style.opacity = '1';
            document.getElementById('currentTrackName').textContent = displayName || filename;
            document.getElementById('currentTrackInfo').textContent = 'Playing...';
            document.getElementById('playBtn').textContent = '‚è∏';

            // Add to playback history
            addToHistory(filename, displayName);
        }

        function togglePlay() {
            if (!audioPlayer.src) return;

            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => console.error('Play error:', e));
                document.getElementById('playBtn').textContent = '‚è∏';
            } else {
                audioPlayer.pause();
                document.getElementById('playBtn').textContent = '‚ñ∂';
            }
        }

        // Skip forward to next track or restart current if < 3 seconds
        function skipForward() {
            if (playQueue.length === 0) {
                showNotification('‚ö†Ô∏è No tracks in queue', 'error');
                return;
            }

            // If shuffle is on, pick a random track
            if (shuffleMode && playQueue.length > 1) {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * playQueue.length);
                } while (randomIndex === currentTrackIndex && playQueue.length > 1);
                playTrackFromQueue(randomIndex);
            } else {
                // Normal forward: go to next track
                const nextIndex = (currentTrackIndex + 1) % playQueue.length;
                playTrackFromQueue(nextIndex);
            }
        }

        // Skip backward: restart if > 3 seconds, otherwise go to previous track
        function skipBackward() {
            if (playQueue.length === 0) {
                showNotification('‚ö†Ô∏è No tracks in queue', 'error');
                return;
            }

            // If more than 3 seconds into the track, restart it
            if (audioPlayer.currentTime > 3) {
                audioPlayer.currentTime = 0;
                showNotification('‚èÆ Restarting track', 'info');
            } else {
                // Go to previous track
                const prevIndex = (currentTrackIndex - 1 + playQueue.length) % playQueue.length;
                playTrackFromQueue(prevIndex);
            }
        }

        // Play track from queue by index
        function playTrackFromQueue(index) {
            if (index < 0 || index >= playQueue.length) {
                showNotification('‚ö†Ô∏è Invalid track index', 'error');
                return;
            }

            currentTrackIndex = index;
            const track = playQueue[index];
            playFile(track.filename, track.displayName);
        }

        // Progress bar
        audioPlayer.addEventListener('timeupdate', () => {
            if (!isNaN(audioPlayer.duration)) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
                document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
            }
        });

        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function seekTo(event) {
            if (!audioPlayer.duration) return;
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
            audioPlayer.currentTime = audioPlayer.duration * percent;
        }

        function setVolume(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
            audioPlayer.volume = percent;
            document.getElementById('volumeFill').style.width = (percent * 100) + '%';
        }

        // Repeat/Loop functionality
        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 2; // Currently only 2 modes: 0 and 1 (will add mode 2 later with queue)
            localStorage.setItem('repeatMode', repeatMode);
            updateRepeatButton();
            updateAudioLoop();
        }

        function updateRepeatButton() {
            const btn = document.getElementById('repeatBtn');
            if (repeatMode === 0) {
                // No repeat
                btn.classList.remove('active');
                btn.title = 'No Repeat';
                btn.textContent = 'üîÅ';
            } else if (repeatMode === 1) {
                // Repeat one
                btn.classList.add('active');
                btn.title = 'Repeat One';
                btn.textContent = 'üîÇ';
            }
            // Mode 2 (Repeat All) will be added later with queue feature
        }

        function updateAudioLoop() {
            audioPlayer.loop = (repeatMode === 1);
        }

        // Shuffle functionality
        function toggleShuffle() {
            shuffleMode = !shuffleMode;
            localStorage.setItem('shuffleMode', shuffleMode);
            updateShuffleButton();
        }

        function updateShuffleButton() {
            const btn = document.getElementById('shuffleBtn');
            if (shuffleMode) {
                btn.classList.add('active');
                btn.title = 'Shuffle On';
            } else {
                btn.classList.remove('active');
                btn.title = 'Shuffle Off';
            }
        }

        // Initialize button states
        updateRepeatButton();
        updateShuffleButton();

        // Playlist Management
        let playlists = JSON.parse(localStorage.getItem('playlists')) || {};

        function saveQueueAsPlaylist() {
            if (playQueue.length === 0) {
                showNotification('‚ùå Queue is empty. Add some tracks first!', 'error');
                return;
            }

            const name = prompt('Enter playlist name:', `Playlist ${Object.keys(playlists).length + 1}`);
            if (!name || name.trim() === '') return;

            const playlistId = Date.now().toString();
            playlists[playlistId] = {
                id: playlistId,
                name: name.trim(),
                created: new Date().toISOString(),
                tracks: [...playQueue]
            };

            localStorage.setItem('playlists', JSON.stringify(playlists));
            showNotification(`‚úÖ Playlist "${name}" saved with ${playQueue.length} track(s)!`, 'success');
        }

        function openPlaylistManager() {
            const modal = document.getElementById('playlistManagerModal');
            const listContainer = document.getElementById('playlistsList');

            // Load playlists
            playlists = JSON.parse(localStorage.getItem('playlists')) || {};
            const playlistIds = Object.keys(playlists);

            if (playlistIds.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: var(--spotify-text-gray); padding: 40px 20px;">
                        No playlists yet. Save your current queue to create one!
                    </div>
                `;
            } else {
                listContainer.innerHTML = playlistIds.map(id => {
                    const pl = playlists[id];
                    const date = new Date(pl.created).toLocaleDateString();
                    return `
                        <div class="playlist-card" style="background: var(--spotify-gray); padding: 16px; border-radius: 8px; border: 1px solid var(--spotify-light-gray);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 4px 0; color: var(--spotify-text); font-size: 16px;">üìã ${pl.name}</h4>
                                    <p style="margin: 0; color: var(--spotify-text-gray); font-size: 12px;">${pl.tracks.length} track(s) ‚Ä¢ ${date}</p>
                                </div>
                                <button onclick="deletePlaylist('${id}')" style="background: transparent; border: none; color: var(--spotify-text-gray); cursor: pointer; font-size: 18px; padding: 4px;" title="Delete Playlist">üóëÔ∏è</button>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button onclick="loadPlaylist('${id}')" style="flex: 1; padding: 8px; background: var(--spotify-green); border: none; color: var(--spotify-darker); border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    ‚ñ∂ Load
                                </button>
                                <button onclick="exportPlaylist('${id}')" style="flex: 1; padding: 8px; background: transparent; border: 1px solid var(--spotify-light-gray); color: var(--spotify-text); border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    üì§ Export
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            modal.style.display = 'flex';
        }

        function closePlaylistManager() {
            document.getElementById('playlistManagerModal').style.display = 'none';
        }

        function loadPlaylist(playlistId) {
            const pl = playlists[playlistId];
            if (!pl) {
                showNotification('‚ùå Playlist not found!', 'error');
                return;
            }

            playQueue = [...pl.tracks];
            updateQueuePanel();
            closePlaylistManager();
            showNotification(`‚úÖ Loaded playlist "${pl.name}" with ${pl.tracks.length} track(s)!`, 'success');
        }

        function deletePlaylist(playlistId) {
            const pl = playlists[playlistId];
            if (!pl) return;

            if (!confirm(`Delete playlist "${pl.name}"?`)) return;

            delete playlists[playlistId];
            localStorage.setItem('playlists', JSON.stringify(playlists));
            openPlaylistManager(); // Refresh
            showNotification(`‚úÖ Playlist "${pl.name}" deleted!`, 'success');
        }

        function exportPlaylist(playlistId) {
            const pl = playlists[playlistId];
            if (!pl) {
                showNotification('‚ùå Playlist not found!', 'error');
                return;
            }

            const blob = new Blob([JSON.stringify(pl, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${pl.name.replace(/[^a-z0-9]/gi, '_')}_playlist.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification(`‚úÖ Exported "${pl.name}"!`, 'success');
        }

        function exportAllPlaylists() {
            if (Object.keys(playlists).length === 0) {
                showNotification('‚ùå No playlists to export!', 'error');
                return;
            }

            const exportData = {
                version: '1.0',
                exported: new Date().toISOString(),
                playlists: playlists
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voiceverse_playlists_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification(`‚úÖ Exported ${Object.keys(playlists).length} playlist(s)!`, 'success');
        }

        function importPlaylists(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Check if it's a single playlist or full export
                    if (data.id && data.tracks) {
                        // Single playlist
                        const newId = Date.now().toString();
                        playlists[newId] = {
                            ...data,
                            id: newId,
                            imported: new Date().toISOString()
                        };
                        localStorage.setItem('playlists', JSON.stringify(playlists));
                        showNotification(`‚úÖ Imported playlist "${data.name}"!`, 'success');
                    } else if (data.playlists) {
                        // Full export
                        let count = 0;
                        Object.values(data.playlists).forEach(pl => {
                            const newId = Date.now().toString() + count;
                            playlists[newId] = {
                                ...pl,
                                id: newId,
                                imported: new Date().toISOString()
                            };
                            count++;
                        });
                        localStorage.setItem('playlists', JSON.stringify(playlists));
                        showNotification(`‚úÖ Imported ${count} playlist(s)!`, 'success');
                    } else {
                        showNotification('‚ùå Invalid playlist file format!', 'error');
                    }

                    openPlaylistManager(); // Refresh
                } catch (err) {
                    showNotification('‚ùå Error reading playlist file!', 'error');
                    console.error(err);
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Search
        function filterFiles() {
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            let found = false;

            document.querySelectorAll('.file-card').forEach(card => {
                const name = (card.dataset.name || '').toLowerCase();
                const filename = (card.dataset.filename || '').toLowerCase();

                if (name.includes(term) || filename.includes(term)) {
                    card.style.display = '';
                    found = true;
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Filter by group
        let currentGroup = null;
        function filterByGroup(groupName) {
            showSection('home');
            currentGroup = groupName;

            // Update group item active states
            document.querySelectorAll('.group-item').forEach(item => {
                item.classList.remove('active');
            });

            // Filter file cards
            let visibleCount = 0;
            document.querySelectorAll('.file-card').forEach(card => {
                const cardGroup = card.dataset.group || '';

                if (!groupName || cardGroup === groupName) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Update title
            const titleEl = document.getElementById('sectionTitleText');
            if (groupName) {
                titleEl.textContent = `Group: ${groupName}`;
                // Highlight active group
                document.querySelectorAll('.group-item').forEach(item => {
                    if (item.textContent.includes(groupName)) {
                        item.classList.add('active');
                    }
                });
            } else {
                titleEl.textContent = 'Recent Files';
            }
        }

        // Playback History Functions
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                displayHistory(data.history || []);
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');

            if (!history || history.length === 0) {
                historyList.innerHTML = '<div class="no-history">No playback history yet</div>';
                return;
            }

            historyList.innerHTML = history.map(entry => `
                <div class="history-item" onclick="playFile('${entry.filename}', '${entry.name}')">
                    <div class="history-item-info">
                        <div class="history-item-name">${entry.name}</div>
                        <div class="history-item-time">${formatHistoryTime(entry.timestamp)}</div>
                    </div>
                    <button class="history-play-btn" onclick="event.stopPropagation(); playFile('${entry.filename}', '${entry.name}')">‚ñ∂</button>
                </div>
            `).join('');
        }

        function formatHistoryTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        async function addToHistory(filename, displayName) {
            try {
                await fetch('/api/add-to-history', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filename: filename,
                        display_name: displayName
                    })
                });
                // Reload history to show the new entry
                loadHistory();
            } catch (error) {
                console.error('Error adding to history:', error);
            }
        }

        async function clearHistory() {
            if (!confirm('Clear all playback history?')) return;

            try {
                const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
                const response = await fetch('/api/clear-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken && { 'X-CSRFToken': csrfToken })
                    }
                });
                if (response.ok) {
                    loadHistory(); // Reload to show empty state
                } else {
                    alert('Failed to clear history');
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                alert('Error clearing history');
            }
        }

        // Bulk Selection Management
        let selectedFiles = new Set();

        function toggleFileSelection(filename, checkbox) {
            if (checkbox.checked) {
                selectedFiles.add(filename);
                checkbox.closest('.file-card').classList.add('selected');
            } else {
                selectedFiles.delete(filename);
                checkbox.closest('.file-card').classList.remove('selected');
            }
            updateBulkActionBar();
        }

        function selectAll() {
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                const filename = checkbox.closest('.file-card').dataset.filename;
                selectedFiles.add(filename);
                checkbox.closest('.file-card').classList.add('selected');
            });
            updateBulkActionBar();
        }

        function deselectAll() {
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.file-card').classList.remove('selected');
            });
            selectedFiles.clear();
            updateBulkActionBar();
        }

        let bulkMenuOpen = false;

        function updateBulkActionBar() {
            const count = selectedFiles.size;
            const toggleBtn = document.getElementById('bulkToggleBtn');
            const bulkBar = document.getElementById('bulkActionBar');
            const countEl = document.getElementById('bulkCount');
            const toggleCountEl = document.getElementById('bulkToggleCount');

            if (count > 0) {
                toggleBtn.classList.add('active');
                countEl.textContent = `${count} selected`;
                toggleCountEl.textContent = `${count} selected`;
            } else {
                toggleBtn.classList.remove('active');
                bulkBar.classList.remove('active');
                bulkMenuOpen = false;
            }
        }

        function toggleBulkMenu() {
            const bulkBar = document.getElementById('bulkActionBar');
            bulkMenuOpen = !bulkMenuOpen;

            if (bulkMenuOpen) {
                bulkBar.classList.add('active');
            } else {
                bulkBar.classList.remove('active');
            }
        }

        // Close bulk menu when clicking outside
        document.addEventListener('click', function(event) {
            const bulkBar = document.getElementById('bulkActionBar');
            const toggleBtn = document.getElementById('bulkToggleBtn');

            if (bulkMenuOpen && !bulkBar.contains(event.target) && !toggleBtn.contains(event.target)) {
                bulkBar.classList.remove('active');
                bulkMenuOpen = false;
            }
        });

        async function bulkDelete() {
            if (selectedFiles.size === 0) return;

            if (!confirm(`Delete ${selectedFiles.size} selected file(s)?`)) return;

            try {
                const response = await fetch('/bulk-delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filenames: Array.from(selectedFiles)})
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to delete files');
                }
            } catch (error) {
                console.error('Error deleting files:', error);
                alert('Error deleting files');
            }
        }

        async function bulkMoveToGroup() {
            if (selectedFiles.size === 0) return;

            try {
                // Fetch existing groups
                const response = await fetch('/api/groups');
                const data = await response.json();

                if (!data.success) {
                    alert('Failed to load groups');
                    return;
                }

                // Show modal with groups
                showGroupSelectModal(data.groups);
            } catch (error) {
                console.error('Error loading groups:', error);
                alert('Error loading groups');
            }
        }

        function showGroupSelectModal(groups) {
            const modal = document.getElementById('groupSelectModal');
            const listContainer = document.getElementById('groupSelectList');

            // Clear previous content
            listContainer.innerHTML = '';

            // Add existing groups
            for (const [groupName, count] of Object.entries(groups)) {
                const item = document.createElement('div');
                item.className = 'group-select-item';
                item.innerHTML = `
                    <span>üìÅ ${groupName}</span>
                    <span style="color: var(--spotify-text-gray); font-size: 14px;">${count} files</span>
                `;
                item.onclick = () => moveToSelectedGroup(groupName);
                listContainer.appendChild(item);
            }

            // Add "Create New Group" option
            const newGroupItem = document.createElement('div');
            newGroupItem.className = 'group-select-item new-group';
            newGroupItem.innerHTML = `
                <span>‚ûï Create New Group</span>
            `;
            newGroupItem.onclick = () => createNewGroup();
            listContainer.appendChild(newGroupItem);

            // Show modal
            modal.classList.add('active');
        }

        function closeGroupSelectModal() {
            const modal = document.getElementById('groupSelectModal');
            modal.classList.remove('active');
        }

        async function moveToSelectedGroup(groupName) {
            try {
                const response = await fetch('/bulk-move', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filenames: Array.from(selectedFiles),
                        group: groupName
                    })
                });

                if (response.ok) {
                    closeGroupSelectModal();
                    window.location.reload();
                } else {
                    alert('Failed to move files');
                }
            } catch (error) {
                console.error('Error moving files:', error);
                alert('Error moving files');
            }
        }

        async function createNewGroup() {
            const groupName = prompt('Enter new group name:');
            if (!groupName || !groupName.trim()) return;

            try {
                const response = await fetch('/bulk-move', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filenames: Array.from(selectedFiles),
                        group: groupName.trim()
                    })
                });

                if (response.ok) {
                    closeGroupSelectModal();
                    window.location.reload();
                } else {
                    alert('Failed to create group');
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Error creating group');
            }
        }

        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            // Validate file type
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.txt') && !fileName.endsWith('.docx') && !fileName.endsWith('.pdf')) {
                alert('Please upload a .txt, .docx, or .pdf file');
                return;
            }

            // Validate file size (max 10MB for safety)
            if (file.size > 10 * 1024 * 1024) {
                alert('File is too large. Please upload a file smaller than 10MB');
                return;
            }

            // Handle .txt files (client-side)
            if (fileName.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;

                    // Check character limit
                    if (content.length > 50000) {
                        alert('File content exceeds 50,000 characters. Only the first 50,000 characters will be used.');
                        document.getElementById('textInput').value = content.substring(0, 50000);
                    } else {
                        document.getElementById('textInput').value = content;
                    }

                    // Update character count
                    updateCharCount();

                    // Show uploaded file info
                    document.getElementById('uploadedFileName').textContent = file.name;
                    document.getElementById('uploadedFileInfo').style.display = 'flex';
                    document.getElementById('fileUploadArea').style.display = 'none';
                };

                reader.onerror = function() {
                    alert('Error reading file. Please try again.');
                };

                reader.readAsText(file);
            }
            // Handle .docx files (server-side)
            else if (fileName.endsWith('.docx')) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/api/parse-docx', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        document.getElementById('textInput').value = result.text;
                        updateCharCount();

                        if (result.truncated) {
                            alert(`File content was ${result.original_length} characters. Only the first 50,000 characters will be used.`);
                        }

                        // Show uploaded file info
                        document.getElementById('uploadedFileName').textContent = file.name;
                        document.getElementById('uploadedFileInfo').style.display = 'flex';
                        document.getElementById('fileUploadArea').style.display = 'none';
                    } else {
                        alert(result.error || 'Error parsing DOCX file');
                    }
                } catch (error) {
                    console.error('Error uploading DOCX:', error);
                    alert('Error processing DOCX file. Please try again.');
                }
            }
            // Handle .pdf files (server-side)
            else if (fileName.endsWith('.pdf')) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/api/parse-pdf', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        document.getElementById('textInput').value = result.text;
                        updateCharCount();

                        if (result.truncated) {
                            alert(`PDF has ${result.pages} pages with ${result.original_length} characters. Only the first 50,000 characters will be used.`);
                        } else {
                            alert(`Successfully extracted text from ${result.pages} pages (${result.original_length} characters).`);
                        }

                        // Show uploaded file info
                        document.getElementById('uploadedFileName').textContent = file.name;
                        document.getElementById('uploadedFileInfo').style.display = 'flex';
                        document.getElementById('fileUploadArea').style.display = 'none';
                    } else {
                        alert(result.error || 'Error parsing PDF file');
                    }
                } catch (error) {
                    console.error('Error uploading PDF:', error);
                    alert('Error processing PDF file. Please try again.');
                }
            }
        }

        function removeUploadedFile() {
            document.getElementById('textInput').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('fileUploadArea').style.display = 'block';
            updateCharCount();
        }

        // Drag and Drop functionality
        const fileUploadArea = document.getElementById('fileUploadArea');

        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        // Voice Comparison Functions
        let comparisonAudio = new Audio();
        let currentComparisonVoice = null;
        let isComparing = false;

        // Update comparison character count
        document.getElementById('comparisonText').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('comparisonCharCount').textContent = count;
        });

        async function playComparison(voice) {
            const text = document.getElementById('comparisonText').value.trim();

            if (!text) {
                alert('Please enter some text to compare voices');
                return;
            }

            const btn = document.getElementById('btn-' + voice);
            const card = document.getElementById('card-' + voice);

            try {
                // Disable button and show loading
                btn.disabled = true;
                btn.innerHTML = '<span>‚è≥</span><span>Loading...</span>';

                // Stop any currently playing comparison
                if (currentComparisonVoice) {
                    comparisonAudio.pause();
                    resetComparisonUI(currentComparisonVoice);
                }

                currentComparisonVoice = voice;
                card.classList.add('playing');

                // Fetch audio from preview endpoint with custom text
                const response = await fetch(`/preview/${voice}?text=${encodeURIComponent(text)}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to generate preview');
                }

                // Get arrayBuffer and create blob with explicit MIME type
                const arrayBuffer = await response.arrayBuffer();

                // Verify we got content
                if (arrayBuffer.byteLength === 0) {
                    throw new Error('Empty audio response from server');
                }

                // Create blob with explicit audio/mpeg MIME type for browser compatibility
                const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
                const url = URL.createObjectURL(blob);

                // Create new audio element to avoid stale state issues
                comparisonAudio = new Audio(url);
                btn.innerHTML = '<span>‚ñ∂</span><span>Playing...</span>';

                comparisonAudio.onended = function() {
                    resetComparisonUI(voice);
                    currentComparisonVoice = null;
                    URL.revokeObjectURL(url);
                };

                comparisonAudio.onerror = function(e) {
                    console.error('Audio load error:', e);
                    resetComparisonUI(voice);
                    currentComparisonVoice = null;
                    URL.revokeObjectURL(url);
                    throw new Error('Failed to load audio');
                };

                await comparisonAudio.play();

            } catch (error) {
                console.error('Error playing comparison:', error);
                // Show specific error message from server
                const errorMsg = error.message || 'Error playing voice preview. Please try again.';
                if (errorMsg.includes('API key')) {
                    alert(errorMsg + '\\n\\nGo to Settings to configure your OpenAI API key.');
                } else {
                    alert('Error playing voice preview: ' + errorMsg);
                }
                resetComparisonUI(voice);
                currentComparisonVoice = null;
            }
        }

        function resetComparisonUI(voice) {
            const btn = document.getElementById('btn-' + voice);
            const card = document.getElementById('card-' + voice);

            btn.disabled = false;
            btn.innerHTML = '<span>‚ñ∂</span><span>Play</span>';
            card.classList.remove('playing');
        }

        async function compareAllVoices() {
            const text = document.getElementById('comparisonText').value.trim();

            if (!text) {
                alert('Please enter some text to compare voices');
                return;
            }

            if (isComparing) {
                return;
            }

            isComparing = true;
            const compareBtn = document.getElementById('compareAllBtn');
            compareBtn.disabled = true;
            compareBtn.textContent = 'üéµ Playing all voices...';

            const voices = ['alloy', 'echo', 'fable', 'onyx', 'nova', 'shimmer'];

            for (const voice of voices) {
                await playComparisonSequential(voice, text);
                // Wait 1 second between voices
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            isComparing = false;
            compareBtn.disabled = false;
            compareBtn.textContent = 'üéµ Compare All Voices';
        }

        async function playComparisonSequential(voice, text) {
            return new Promise(async (resolve, reject) => {
                const btn = document.getElementById('btn-' + voice);
                const card = document.getElementById('card-' + voice);

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<span>‚è≥</span><span>Loading...</span>';
                    card.classList.add('playing');

                    const response = await fetch(`/preview/${voice}?text=${encodeURIComponent(text)}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Failed to generate preview');
                    }

                    // Get arrayBuffer and create blob with explicit MIME type
                    const arrayBuffer = await response.arrayBuffer();

                    // Verify we got content
                    if (arrayBuffer.byteLength === 0) {
                        throw new Error('Empty audio response from server');
                    }

                    // Create blob with explicit audio/mpeg MIME type for browser compatibility
                    const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
                    const url = URL.createObjectURL(blob);

                    const audio = new Audio(url);
                    btn.innerHTML = '<span>‚ñ∂</span><span>Playing...</span>';

                    audio.onended = function() {
                        resetComparisonUI(voice);
                        URL.revokeObjectURL(url);
                        resolve();
                    };

                    audio.onerror = function(e) {
                        console.error('Audio load error:', e);
                        resetComparisonUI(voice);
                        URL.revokeObjectURL(url);
                        reject(new Error('Audio playback error'));
                    };

                    await audio.play();

                } catch (error) {
                    console.error('Error in sequential comparison:', error);
                    const errorMsg = error.message || '';
                    if (errorMsg.includes('API key')) {
                        // Stop comparing all - API key issue affects all voices
                        alert(errorMsg + '\\n\\nGo to Settings to configure your OpenAI API key.');
                        isComparing = false;
                        const compareBtn = document.getElementById('compareAllBtn');
                        compareBtn.disabled = false;
                        compareBtn.textContent = 'üéµ Compare All Voices';
                        reject(error);
                        return;
                    }
                    resetComparisonUI(voice);
                    resolve(); // Continue to next voice even if this one fails
                }
            });
        }

        // Speed slider update
        function updateSpeedLabel(value) {
            document.getElementById('speedLabel').textContent = value + 'x';
        }

        // AI Agent Functions
        let currentSuggestions = null;

        async function getAISuggestions() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Please enter some text first');
                return;
            }

            const btn = document.getElementById('aiSuggestBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Analyzing...</span>';

            try {
                const response = await fetch('/api/agent/suggest-metadata', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });

                const data = await response.json();
                if (data.success && data.suggestions) {
                    currentSuggestions = data.suggestions;
                    showAISuggestionsModal(data.suggestions);
                } else {
                    alert('Failed to get suggestions: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üí°</span><span>Get AI Suggestions</span><small style="display: block; font-size: 11px; opacity: 0.8; font-weight: normal;">Auto-fill filename, category & voice</small>';
            }
        }

        function showAISuggestionsModal(suggestions) {
            // Show/hide filename suggestion
            const filenameInput = document.getElementById('filename');
            const hasExistingFilename = filenameInput.value.trim() !== '';

            if (suggestions.filename && !hasExistingFilename) {
                document.getElementById('filenameSuggestion').style.display = 'block';
                document.getElementById('filenameSuggestionText').textContent = suggestions.filename;
                document.getElementById('acceptFilename').checked = true;
            } else {
                document.getElementById('filenameSuggestion').style.display = 'none';
            }

            // Show category suggestion
            if (suggestions.category) {
                document.getElementById('categorySuggestion').style.display = 'block';
                document.getElementById('categorySuggestionText').textContent = suggestions.category;
                document.getElementById('acceptCategory').checked = true;
            }

            // Show voice suggestion
            if (suggestions.recommended_voice) {
                document.getElementById('voiceSuggestion').style.display = 'block';
                const voiceName = suggestions.recommended_voice.charAt(0).toUpperCase() + suggestions.recommended_voice.slice(1);
                document.getElementById('voiceSuggestionText').textContent = voiceName;
                document.getElementById('acceptVoice').checked = true;
            }

            // Show summary
            if (suggestions.summary) {
                document.getElementById('summarySuggestionText').textContent = suggestions.summary;
            }

            // Show modal
            document.getElementById('aiSuggestionsModal').style.display = 'flex';
        }

        function closeAISuggestionsModal() {
            document.getElementById('aiSuggestionsModal').style.display = 'none';
            currentSuggestions = null;
        }

        function applySelectedSuggestions() {
            if (!currentSuggestions) return;

            const s = currentSuggestions;

            // Apply filename if accepted
            if (document.getElementById('acceptFilename')?.checked && s.filename) {
                document.getElementById('filename').value = s.filename;
            }

            // Apply category if accepted
            if (document.getElementById('acceptCategory')?.checked && s.category) {
                document.getElementById('group').value = s.category;
            }

            // Apply voice if accepted
            if (document.getElementById('acceptVoice')?.checked && s.recommended_voice) {
                const voiceRadio = document.querySelector(`input[name="voice"][value="${s.recommended_voice}"]`);
                if (voiceRadio) {
                    voiceRadio.checked = true;
                    const voiceCard = voiceRadio.closest('.voice-card');
                    if (voiceCard) {
                        document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
                        voiceCard.classList.add('selected');
                    }
                }
            }

            closeAISuggestionsModal();
        }

        async function analyzeText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Please enter some text first');
                return;
            }

            const btn = document.getElementById('aiAnalyzeBtn');
            const resultsDiv = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('analysisContent');

            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Analyzing...</span>';

            try {
                const response = await fetch('/api/agent/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });

                const data = await response.json();
                if (data.success && data.analysis) {
                    const a = data.analysis;

                    let html = '<div style="color: var(--spotify-text);">';
                    html += `<div style="font-weight: 600; margin-bottom: 12px; color: #bb86fc;">üìä Text Analysis</div>`;
                    html += `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">`;
                    html += `<div><strong>Characters:</strong> ${a.character_count}</div>`;
                    html += `<div><strong>Words:</strong> ${a.word_count}</div>`;
                    html += `<div><strong>Est. Duration:</strong> ${a.estimated_duration_minutes} min</div>`;
                    html += `<div><strong>Quality Score:</strong> ${a.quality_score}/100</div>`;
                    html += `</div>`;

                    if (a.warnings && a.warnings.length > 0) {
                        html += '<div style="color: #ff9800; margin-top: 8px;"><strong>‚ö†Ô∏è Warnings:</strong><ul style="margin: 4px 0; padding-left: 20px;">';
                        a.warnings.forEach(w => html += `<li>${w}</li>`);
                        html += '</ul></div>';
                    }

                    if (a.issues && a.issues.length > 0) {
                        html += '<div style="color: #ff6b6b; margin-top: 8px;"><strong>‚ùå Issues:</strong><ul style="margin: 4px 0; padding-left: 20px;">';
                        a.issues.forEach(i => html += `<li>${i}</li>`);
                        html += '</ul></div>';
                    }

                    if ((!a.warnings || a.warnings.length === 0) && (!a.issues || a.issues.length === 0)) {
                        html += '<div style="color: #4caf50; margin-top: 8px;">‚úÖ Text looks good for TTS generation!</div>';
                    }

                    html += '</div>';
                    contentDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                } else {
                    alert('Failed to analyze text: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üìä</span><span>Analyze Text Quality</span><small style="display: block; font-size: 11px; opacity: 0.8; font-weight: normal;">Check for issues & get recommendations</small>';
            }
        }

        // Queue System
        let playQueue = JSON.parse(localStorage.getItem('playQueue')) || [];
        let queueIndex = -1;
        let currentTrackIndex = -1; // Track current playing index for skip buttons

        function toggleQueue() {
            document.getElementById('queuePanel').classList.toggle('active');
        }

        function addToQueue(filename, displayName) {
            playQueue.push({filename, name: displayName});
            localStorage.setItem('playQueue', JSON.stringify(playQueue));
            updateQueueUI();
        }

        function contextAddToQueue() {
            addToQueue(currentFilename, currentFileName);
            document.getElementById('contextMenu').classList.remove('active');
        }

        function removeFromQueue(index) {
            playQueue.splice(index, 1);
            if (queueIndex >= index) queueIndex--;
            localStorage.setItem('playQueue', JSON.stringify(playQueue));
            updateQueueUI();
        }

        function playFromQueue(index) {
            queueIndex = index;
            const item = playQueue[index];
            playFile(item.filename, item.name);
            updateQueueUI();
        }

        function playNextInQueue() {
            if (playQueue.length > 0 && queueIndex < playQueue.length - 1) {
                playFromQueue(queueIndex + 1);
            }
        }

        function updateQueueUI() {
            const list = document.getElementById('queueList');
            const count = document.getElementById('queueCount');
            count.textContent = playQueue.length;

            if (playQueue.length === 0) {
                list.innerHTML = '<div style="color: var(--spotify-text-gray); text-align: center; padding: 40px 20px;">Queue is empty. Right-click files and select "Add to Queue"</div>';
                return;
            }

            list.innerHTML = playQueue.map((item, index) => `
                <div class="queue-item ${index === queueIndex ? 'playing' : ''}" onclick="playFromQueue(${index})">
                    <div class="queue-item-name">${item.name}</div>
                    <button class="queue-item-remove" onclick="event.stopPropagation(); removeFromQueue(${index})">√ó</button>
                </div>
            `).join('');
        }

        // Auto-play next in queue when current finishes
        audioPlayer.addEventListener('ended', function() {
            if (repeatMode === 1) {
                // Repeat one - just replay the current track
                audioPlayer.play();
            } else {
                // Remove the completed track from queue and play next
                if (currentTrackIndex >= 0 && currentTrackIndex < playQueue.length) {
                    playQueue.splice(currentTrackIndex, 1);
                    localStorage.setItem('playQueue', JSON.stringify(playQueue));

                    // Adjust index after removal
                    if (currentTrackIndex >= playQueue.length) {
                        currentTrackIndex = 0;
                    }

                    // Play next track if queue has more
                    if (playQueue.length > 0) {
                        playTrackFromQueue(currentTrackIndex);
                    } else {
                        currentTrackIndex = -1;
                        document.getElementById('playBtn').textContent = '‚ñ∂';
                        showNotification('‚úÖ Queue completed!', 'success');
                    }

                    updateQueueUI();
                } else {
                    // Fallback to old behavior if currentTrackIndex not set
                    playNextInQueue();
                }
            }
        });

        // Initialize queue
        updateQueueUI();

        // Drag & Drop Functions
        let draggedFile = null;

        function handleDragStart(event) {
            draggedFile = {
                filename: event.target.dataset.filename,
                name: event.target.dataset.name,
                group: event.target.dataset.group
            };
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedFile = null;
        }

        function handleDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(event, targetGroup) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            event.preventDefault();

            event.currentTarget.classList.remove('drag-over');

            if (!draggedFile) return;

            // Don't do anything if dropping on the same group
            if (draggedFile.group === targetGroup) {
                return;
            }

            try {
                const response = await fetch('/api/move-to-group', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filename: draggedFile.filename,
                        group: targetGroup
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reload to show updated groups
                    window.location.reload();
                } else {
                    alert('Failed to move file: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error moving file:', error);
                alert('Error moving file to group');
            }

            return false;
        }

        // Initialize
        audioPlayer.volume = 1.0;
        document.getElementById('volumeFill').style.width = '100%';
        updateRepeatButton(); // Load saved repeat mode
        updateAudioLoop();
        loadHistory(); // Load playback history

        // Voice Cloning Form Interception
        const mainForm = document.querySelector('form[action="/"]');
        if (mainForm) {
            mainForm.addEventListener('submit', async function(e) {
                // Check if voice cloning is enabled
                if (localStorage.getItem('useVoiceClone') === 'true') {
                    e.preventDefault(); // Prevent normal form submission

                    const text = document.querySelector('textarea[name="text"]').value;
                    const filename = document.querySelector('input[name="filename"]').value;
                    const group = document.querySelector('input[name="group"]')?.value || 'Uncategorized';
                    const voiceSampleFilename = localStorage.getItem('voiceSampleFilename');
                    const language = localStorage.getItem('cloneLanguage') || 'en';

                    if (!text || !filename) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    // Show loading state
                    const submitBtn = mainForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Generating with cloned voice...';

                    try {
                        // Get CSRF token
                        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

                        const response = await fetch('/api/voice-clone/generate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(csrfToken && { 'X-CSRFToken': csrfToken })
                            },
                            body: JSON.stringify({
                                text: text,
                                voice_sample_filename: voiceSampleFilename,
                                language: language,
                                display_name: filename,
                                group: group
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Redirect to play the generated file
                            window.location.href = '/?success=1&filename=' + result.filename + '&play_file=' + result.filename;
                        } else {
                            alert('Voice cloning failed: ' + result.error);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    } catch (error) {
                        alert('Error: ' + error.message);
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }
                // If voice cloning not enabled, form submits normally
            });
        }

        {% if success and filename %}
        // Auto-play newly created file and switch to home section
        setTimeout(() => {
            showSection('home');  // Switch to home section first
            setTimeout(() => {
                playFile('{{ filename }}', '{{ file_display_name }}');
            }, 100);
        }, 300);
        {% endif %}
    </script>

</body>
</html>